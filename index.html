<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Void Arcana: US/Mac Ultimate</title>
    <style>
        /* 1. åŸºç¡€è®¾ç½®ï¼šé»‘è‰²èƒŒæ™¯ */
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }
        
        /* 2. è§†é¢‘å±‚ï¼šMac Safari å¿…é¡»å¯è§ä½†é€æ˜ï¼Œä¸èƒ½ display:none */
        #videoElement {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0; z-index: -1; pointer-events: none;
        }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* 3. UI å±‚ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ */
        }

        /* 4. å¯åŠ¨æŒ‰é’® (å…³é”®ï¼) */
        #start-btn {
            pointer-events: auto; /* åªæœ‰æŒ‰é’®èƒ½ç‚¹ */
            padding: 20px 50px; font-size: 24px; font-weight: bold;
            color: #00ffff; background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ffff; border-radius: 10px;
            cursor: pointer; box-shadow: 0 0 20px #00ffff;
            transition: 0.3s;
        }
        #start-btn:hover { background: #00ffff; color: #000; }

        /* 5. è°ƒè¯• HUD (å·¦ä¸Šè§’) */
        #debug-hud {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            color: lime; font-size: 14px; background: rgba(0,0,0,0.5); padding: 5px;
            display: none; pointer-events: none;
        }
        
        /* æ¸¸æˆå†…è¯´æ˜ */
        #instructions {
            position: absolute; bottom: 20px; left: 20px; z-index: 100;
            color: rgba(255,255,255,0.7); display: none; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="debug-hud">
    <div>FPS: <span id="fps-val">0</span></div>
    <div>Hands: <span id="hand-count">0</span></div>
    <div>Status: <span id="status-text">Init...</span></div>
</div>

<div id="ui-layer">
    <h1 style="text-shadow: 0 0 10px #00ffff; margin-bottom: 20px;">VOID ARCANA <span style="font-size:0.5em">MAC/US</span></h1>
    <button id="start-btn" onclick="startApp()">CLICK TO START</button>
    <div id="loading-text" style="margin-top:10px; color:#aaa; display:none;">Loading AI Core...</div>
</div>

<div id="instructions">
    <p>ğŸ–ï¸ <b>Open Hand</b>: Shield</p>
    <p>ğŸ¤˜ <b>Rock Sign</b>: Lightning</p>
    <p>âœŠ <b>Fist</b>: Gravity</p>
</div>

<video id="videoElement" playsinline muted autoplay></video>
<div id="canvas-container"></div>

<script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
    import { FilesetResolver, HandLandmarker } from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.9/+esm';

    // --- å˜é‡ ---
    const debugHud = document.getElementById('debug-hud');
    const handCountEl = document.getElementById('hand-count');
    const fpsEl = document.getElementById('fps-val');
    const statusEl = document.getElementById('status-text');
    let handLandmarker = undefined;
    let isRunning = false;
    let lastTime = 0;
    
    // --- Three.js åˆå§‹åŒ– ---
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.003);
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 20;
    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('canvas-container').appendChild(renderer.domElement);
    scene.add(new THREE.AmbientLight(0xffffff, 0.5)); // è°ƒäº®ä¸€ç‚¹

    // --- é­”æ³•å¯¹è±¡ ---
    const particles = [];
    const lightnings = [];
    let shieldMesh = null;
    
    // æŠ¤ç›¾æè´¨
    const shieldMat = new THREE.MeshPhongMaterial({ 
        color: 0x00ffff, emissive: 0x0044aa, transparent: true, opacity: 0.3, wireframe: true 
    });

    // åæ ‡è½¬æ¢
    function screenToWorld(x, y, z=10) {
        const vec = new THREE.Vector3(((1-x)*2)-1, -(y*2)+1, 0.5);
        vec.unproject(camera);
        vec.sub(camera.position).normalize();
        return camera.position.clone().add(vec.multiplyScalar(-camera.position.z/vec.z + z));
    }

    // --- å¯åŠ¨é€»è¾‘ (ç”¨æˆ·ç‚¹å‡»è§¦å‘) ---
    window.startApp = async function() {
        const btn = document.getElementById('start-btn');
        const loadTxt = document.getElementById('loading-text');
        
        btn.style.display = 'none'; // éšè—æŒ‰é’®
        loadTxt.style.display = 'block'; // æ˜¾ç¤ºåŠ è½½ä¸­
        
        try {
            // 1. åŠ è½½è§†è§‰åº“
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.9/wasm");
            
            // 2. åŠ è½½æ¨¡å‹ (Google æº)
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 2
            });

            // 3. å¼€å¯æ‘„åƒå¤´ (å¿…é¡»åœ¨è¿™é‡Œå¼€å¯)
            const video = document.getElementById('videoElement');
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
            video.srcObject = stream;
            
            // ç­‰å¾…è§†é¢‘æ•°æ®åŠ è½½
            video.onloadeddata = () => {
                video.play(); // å¼ºåˆ¶æ’­æ”¾
                document.getElementById('ui-layer').style.display = 'none'; // éšè—æ‰€æœ‰UI
                debugHud.style.display = 'block'; // æ˜¾ç¤ºè°ƒè¯•
                document.getElementById('instructions').style.display = 'block';
                isRunning = true;
                loop();
            };

        } catch (e) {
            alert("å¯åŠ¨å¤±è´¥: " + e.message);
            console.error(e);
            btn.style.display = 'block';
            btn.innerText = "RETRY";
        }
    }

    // --- ä¸»å¾ªç¯ ---
    function loop() {
        if(!isRunning) return;
        requestAnimationFrame(loop);

        const video = document.getElementById('videoElement');
        const now = performance.now();
        fpsEl.innerText = Math.round(1000 / (now - lastTime));
        lastTime = now;

        // AI è¯†åˆ«
        if (handLandmarker && video.currentTime > 0) {
            const results = handLandmarker.detectForVideo(video, now);
            
            // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºæ£€æµ‹åˆ°äº†å‡ åªæ‰‹
            const count = results.landmarks ? results.landmarks.length : 0;
            handCountEl.innerText = count;
            statusEl.innerText = count > 0 ? "Tracking" : "Scanning...";
            statusEl.style.color = count > 0 ? "#0f0" : "#f00";

            let shieldActive = false;
            let handPos = null;

            if (results.landmarks) {
                for (const lm of results.landmarks) {
                    const idxOpen = lm[8].y < lm[6].y; // ç®€åŒ–ç‰ˆåˆ¤æ–­
                    const pinkyOpen = lm[20].y < lm[18].y;
                    
                    // é€»è¾‘åˆ¤å®š
                    if (idxOpen && pinkyOpen) { // Rock / Spider-Man
                        createLightning(lm[8].x, lm[8].y);
                        createLightning(lm[20].x, lm[20].y);
                    } else if (idxOpen) { // Pointing
                         // ç®€å•çš„ç²’å­
                         spawnParticle(lm[8].x, lm[8].y, 0xffaa00);
                    } else { // Fist / Closed
                        spawnParticle(lm[9].x, lm[9].y, 0x8a2be2); // Void
                    }

                    // æŠ¤ç›¾é€»è¾‘ (å¦‚æœæ˜¯å¼ å¼€æ‰‹)
                    // è¿™é‡Œç®€åŒ–ä¸ºï¼šåªè¦æ£€æµ‹åˆ°æ‰‹ï¼Œå°±å°è¯•æ¿€æ´»æŠ¤ç›¾ï¼ˆä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼‰
                    // å®é™…å¯åŠ ä¸¥è°¨çš„æ‰‹æŒ‡åˆ¤æ–­
                    shieldActive = true;
                    handPos = lm[9]; // æ‰‹æŒä¸­å¿ƒ
                }
            }

            updateShield(shieldActive, handPos);
        }

        // æ¸²æŸ“ç‰¹æ•ˆ
        updateEffects();
        renderer.render(scene, camera);
    }

    // --- ç‰¹æ•ˆå‡½æ•° ---
    function updateShield(active, pos) {
        if(!shieldMesh) {
            shieldMesh = new THREE.Mesh(new THREE.IcosahedronGeometry(3,1), shieldMat);
            scene.add(shieldMesh);
        }
        shieldMesh.visible = active;
        if(active && pos) {
            const worldPos = screenToWorld(pos.x, pos.y, -5);
            shieldMesh.position.lerp(worldPos, 0.2);
            shieldMesh.rotation.z += 0.05;
        }
    }

    function createLightning(x, y) {
        if(Math.random() > 0.4) return;
        const start = screenToWorld(x, y, -2);
        const end = start.clone().add(new THREE.Vector3((Math.random()-.5)*10, (Math.random()-.5)*10, -20));
        
        const pts = []; let curr = start.clone();
        for(let i=0; i<6; i++) {
            pts.push(curr.clone());
            curr.lerp(end, 0.2).add(new THREE.Vector3((Math.random()-.5)*2, (Math.random()-.5)*2, 0));
        }
        const line = new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts), new THREE.LineBasicMaterial({color: 0xaa00ff}));
        scene.add(line);
        lightnings.push({m:line, life:5});
    }

    function spawnParticle(x, y, color) {
        const m = new THREE.Mesh(new THREE.PlaneGeometry(0.3,0.3), new THREE.MeshBasicMaterial({color:color}));
        m.position.copy(screenToWorld(x,y,0));
        m.lookAt(camera.position);
        scene.add(m);
        particles.push({m:m, life:30, v:new THREE.Vector3((Math.random()-.5)*0.2,(Math.random()-.5)*0.2,0)});
    }

    function updateEffects() {
        for(let i=lightnings.length-1; i>=0; i--){
            lightnings[i].life--; 
            if(lightnings[i].life<=0){scene.remove(lightnings[i].m); lightnings.splice(i,1);}
        }
        for(let i=particles.length-1; i>=0; i--){
            particles[i].life--; particles[i].m.position.add(particles[i].v); particles[i].m.material.opacity = particles[i].life/30;
            if(particles[i].life<=0){scene.remove(particles[i].m); particles.splice(i,1);}
        }
    }
    
    // è‡ªé€‚åº”çª—å£
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
